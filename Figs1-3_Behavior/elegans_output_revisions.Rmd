---
title: "Script to analyze behavior data for _C. elegans_ manuscript"
author: "Emily Jane Dennis"
date: "7/20/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

updated 04/27/2018 to include data and analysis for additional behavior experiments and update figure panels


##Purpose:
To plot all behavior data for manuscript.

##Background:
This is an R Markdown document.  <http://rmarkdown.rstudio.com>.

The code required to get these graphs is in the gray boxes, along with information on how to run the statistical tests reported in the paper and  qqPlots that were used to determine if these statistical tests were generally appropriate.

This was run in RStudio, using R version 3.3.1 (2016-10-31), Sincere Pumpkin Patch on a x86_64-apple-darwin13.4.0

Before these data can be analyzed, I used the following code block to:

  1. Load all libraries required for analysis and plotting
  
  2. Load these data
  
  3. Subset data to use later to plot
  
```{r loadinglibs, warning=FALSE,  message = FALSE}
#load libraries
library(plyr)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(multcompView)
library(car)

allbeh <- read.csv('2018Dennis_DEETandCelegans_behaviordata.csv')


#start subsetting data:
hawaiian <- subset(allbeh,expt=='hawaiian')
#hawaiiand didn't have any positive controls that
# had enough responding animals to record
#so I excluded the day. temp in lab was also low that day.
hawaiian <- subset(hawaiian,date!=20160920)

hawaiiane <- subset(hawaiian,percentDEET==0)
hawaiiand <- subset(hawaiian,percentDEET==0.15)

rescue <- subset(allbeh,expt=='rescue'|expt=='rescue2')
rescueE <- subset(rescue,percentDEET==0)
rescueD <- subset(rescue,percentDEET==0.15)
spots <- subset(allbeh,expt=='spots')
screen <- subset(allbeh,expt=='screen2')

bacteria <- subset(allbeh,expt=='bacterial')
ASH <- subset(allbeh,expt=='ASH')
odordrc <- subset(allbeh,expt=='odordrc')

```

First, I tested if DEET is a volatile repellent (1uL 50% DEET in two spots, just as a volatile odorant). Next, I tested if DEET can inhibit attraction to isoamyl alochol if presented as a point stimulus (2uL 50% DEET or solvent was added between each of the two spots of isoamyl alochol (IAA).) Both are plotted below:

DD =  2 x 1uL DEET as point stimulus
EE =  2 x 1uL solvent (ethanol) as point stimulus
IDI = 2 x 1uL spots IAA as point stimulus with 2uL 50% DEET between
IEI = 2 x 1uL spots IAA as point stimulus with 2uL solvent/ethanol between
## Fig 1 b-c
```{r plotfig1b-c}
# make summary data
spotssum <- ddply(spots,c('stimulus'),summarise,N=length(stimulus),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N),mem=mean-se,mep=mean+se)
  
# plot each point, xs are means, +s are standard error
ggplot(spots,aes(x=stimulus,y=CI)) + 
  ggtitle('Testing volatile repellency of DEET') +
  geom_jitter(width=0.2,height=0) +  
  geom_point(data=spotssum,aes(x=stimulus,y=mep),shape=3) +
  geom_point(data=spotssum,aes(x=stimulus,y=mem),shape=3)  +
  geom_point(data=spotssum,aes(x=stimulus,y=mean),shape=4) + 
  theme_tufte() + 
  ylim(-1,1) + 
  geom_hline(yintercept=0)

```

###DEET does not look like a volatile point stimulus: p = 0.6478
```{r statsforfig1b}
EE <- subset(spots,stimulus=="EE")
DD <- subset(spots,stimulus=="DD")
t.test(x=EE$CI,y=DD$CI,"two.sided")
```


###DEET does not interrupt chemotaxis to isoamyl alochol when presented as a point stimulus: p = 0.5286
```{r statsforfig1c}
IDI <- subset(spots,stimulus=="IDI")
ISI <- subset(spots,stimulus=="ISI")

t.test(x=ISI$CI,y=IDI$CI,"two.sided")

```

# Dose-response-like curve for effect of DEET in agarose on IAA chemotaxis
## Fig 1e
```{r plotfordrcN2}
drc <- subset(allbeh,expt=='drc')
drc <- subset(drc,percentDEET<0.2)
drcN2 <- subset(drc,genotype=='N2')

drcN2summary <- ddply(drcN2,c("percentDEET"),summarise,N=length(percentDEET),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N))
drcN2summary$mep <- drcN2summary$mean + drcN2summary$se
drcN2summary$mem <- drcN2summary$mean - drcN2summary$se

ggplot(drcN2,aes(x=as.factor(percentDEET),y=CI)) + 
  ggtitle('DEET dose response') + 
  geom_jitter(width=0.2,height=0) + 
  theme_tufte() + 
  ylim(-1,1) + 
  geom_hline(yintercept=0) + 
  geom_point(data=drcN2summary,aes(x=as.factor(percentDEET),y=mep),shape=3)+ geom_point(data=drcN2summary,aes(x=as.factor(percentDEET),y=mean),shape=4) +
geom_point(data=drcN2summary,aes(x=as.factor(percentDEET),y=mem),shape=3) 

```

Below find the stats for these dose response data

```{r statsfordrcN2}

#plot QQ plot for model used in 2 way anova, if looks like a ~ straight line the residuals are probably normal enough to run the 2 way anova using this model
qqPlot(drcN2$CI)


tukeydrc <- TukeyHSD(aov(formula = CI ~ as.factor(percentDEET), data = drcN2))

Tukeydrc.levels <- tukeydrc$`as.factor(percentDEET)`[,4]
multcompLetters(Tukeydrc.levels)['Letters']

```



### What other odors are affected by DEET
## Fig 1f (not in same order)
```{r}

odor <- subset(allbeh,expt=='odor')

odorsum <- ddply(odor,c("stimulus","percentDEET"),summarise,N=length(stimulus),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N))
odorsum$mep <- odorsum$mean + odorsum$se
odorsum$mem <- odorsum$mean - odorsum$se



ggplot(odor,aes(x=percentDEET,y=CI,color=percentDEET)) + 
  ggtitle('odors on DEET') +  
  geom_jitter(width=0.01,height=0) + 
  theme_tufte() + 
  ylim(-1,1) + 
  geom_hline(yintercept=0) + 
  geom_point(data=odorsum,aes(x=percentDEET,y=mep),shape=3) + 
  geom_point(data=odorsum,aes(x=percentDEET,y=mem),shape=3)  + 
  geom_point(data=odorsum,aes(x=percentDEET,y=mean),shape=4) + 
  theme_tufte() + 
  geom_hline(yintercept=0) + 
  facet_grid(~stimulus)


```

statistics for these data:
```{r stats for odors}


#plot QQ plot for model used in 2 way anova, if looks like a ~ straight line the residuals are probably normal enough to run the 2 way anova using this model
odors.aov = aov(CI~as.factor(percentDEET)*stimulus,data=odor)
plot(odors.aov,which=2)

tukeyodor <- TukeyHSD(aov(formula=CI~as.factor(percentDEET)*as.factor(stimulus),data=odor))

Tukey.levels <- tukeyodor$`as.factor(percentDEET):as.factor(stimulus)`[,4]
multcompLetters(Tukey.levels)['Letters']
  
```


## Fig 1g plotting data for animals chemotaxing to 20uL of bacteria in LB +/- pyrazine or isoamyl alcohol vs LB alone.

```{r plotbacteria}

# make summary data for bacteria
bacteriasummary <-ddply(bacteria,c("stimulus", "percentDEET"),summarise,N=length(CI),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N))
bacteriasummary$mep <- bacteriasummary$mean + bacteriasummary$se
bacteriasummary$mem <- bacteriasummary$mean - bacteriasummary$se

ggplot(bacteria,aes(x=percentDEET,y=CI)) + 
  ggtitle('bacteria experiment')  + 
  geom_point(data=bacteriasummary,aes(x=percentDEET,y=mep),shape=3)  + 
  geom_point(data=bacteriasummary,aes(x=percentDEET,y=mem),shape=3)  + 
  geom_point(data=bacteriasummary,aes(x=percentDEET,y=mean),shape=4)  + 
  geom_jitter(width=0.05,height=0) + 
  theme_tufte() + 
  ylim(-1,1) + 
  geom_hline(yintercept=0) + 
  facet_grid(~stimulus)


```

```{r bacteriastats}
bacteria.aov = aov(CI~as.factor(percentDEET)*stimulus,data=bacteria)

plot(bacteria.aov,which=2)

# looks pretty good

# and Levene's test was not significant 
leveneTest(CI~stimulus*as.factor(percentDEET),data=bacteria)

#stats:
TukeyHSD(aov(CI~stimulus*as.factor(percentDEET),bacteria)) -> tukeybac
Tukeybac.levels <- tukeybac$`stimulus:as.factor(percentDEET)`[,4]
multcompLetters(Tukeybac.levels)['Letters']

```


#Fig 1h-i
```{r odordrc}

# make summary data for bacteria
odordrcsummary <-ddply(odordrc,c("stimulus","percentDEET"),summarise,N=length(CI),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N))
odordrcsummary$mep <- odordrcsummary$mean + odordrcsummary$se
odordrcsummary$mem <- odordrcsummary$mean - odordrcsummary$se

ggplot(odordrc,aes(x=percentDEET,y=CI)) + 
  ggtitle('odor over orders of magnitude experiment')  + 
  geom_point(data=odordrcsummary,aes(x=percentDEET,y=mep),shape=3)  + 
  geom_point(data=odordrcsummary,aes(x=percentDEET,y=mem),shape=3)  + 
  geom_point(data=odordrcsummary,aes(x=percentDEET,y=mean),shape=4)  + 
  geom_jitter(width=0.02,height=0) + 
  theme_tufte() + 
  ylim(-1,1) + 
  geom_hline(yintercept=0) + 
  facet_grid(~stimulus)

```

```{r odordrcstats}

odordrciaa <- subset(odordrc,stimulus!="p01")
odordrciaa <- subset(odordrciaa,stimulus!="p1")
odordrciaa <- subset(odordrciaa,stimulus!="p10")

odordrcpyr <- subset(odordrc,stimulus!="i1")
odordrcpyr <- subset(odordrcpyr,stimulus!="i2")
odordrcpyr <- subset(odordrcpyr,stimulus!="i3")

#qqPlots
qqPlot(odordrciaa$CI)
qqPlot(odordrcpyr$CI)

#levene's tests
leveneTest(CI~stimulus*as.factor(percentDEET),data=odordrciaa)
leveneTest(CI~stimulus*as.factor(percentDEET),data=odordrcpyr)

#stats
tukeyiaadrc <- TukeyHSD(aov(CI~stimulus*as.factor(percentDEET),odordrciaa))
Tukeyiaadrc.levels <- tukeyiaadrc$`stimulus:as.factor(percentDEET)`[,4]
multcompLetters(Tukeyiaadrc.levels)['Letters']

tukeypyrdrc <- TukeyHSD(aov(CI~stimulus*as.factor(percentDEET),odordrcpyr))
Tukeypyrdrc.levels <- tukeypyrdrc$`stimulus:as.factor(percentDEET)`[,4]
multcompLetters(Tukeypyrdrc.levels)['Letters']

```



###Forward genetic screen
I completed a forward genetic screen with help from Wendy Wang in Shai Shaham's lab (and lots of guidance from Shai on both the screen and follow up) plot of genetic screen data:

## Figure 2b
ed03 == LBV003 in paper
ed03 was our in-house name as it was the third mutant I (__E__mily __D__ennis) found

```{r plotscreen}

ggplot(screen,aes(x=genotype,y=CI)) + ggtitle('screen data') + geom_boxplot(outlier.shape=NA,coef=0) + geom_jitter(width=0.2,height=0) + theme_tufte() + ylim(-1,1) + geom_hline(yintercept=0)

```

###EMS-isolated strain LBV003 is DEET-resistant compared to N2 (p-value = 0.003101)

note that in the spreadsheet, all screen and rescue experiments
```{r statsscreen}
N2screen <- subset(screen,genotype=="N2")
ed03screen <- subset(screen,genotype=="ed03")
t.test(x=N2screen$CI,y=ed03screen$CI,"two.sided")
```


## Figure 2e: a wild-isolate is naturally DEET-resistant
```{r plothawaiiandeet}
# make summary data (means, standard errors) to plot
hdsummary <-ddply(hawaiiand,c("genotype"),summarise,N=length(genotype),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N))
hdsummary$mep <- hdsummary$mean + hdsummary$se
hdsummary$mem <- hdsummary$mean - hdsummary$se

#plot hawaiian strains chemotaxing to IAA on DEET agar
ggplot(hawaiiand,aes(x=genotype,y=CI)) + 
  ggtitle('hawaiian deet') + 
  geom_point(data=hdsummary,aes(x=genotype,y=mep),shape=3)  +
  geom_point(data=hdsummary,aes(x=genotype,y=mem),shape=3)  +
  geom_jitter(width=0.2,height=0) + theme_tufte() + ylim(-1,1) +
  geom_hline(yintercept=0) + 
  coord_flip()

```

First I did a qqPlot for these data to test if residuals are roughly normal and an ANOVA is appropriate. Dashed lines on the plot indicate 95% confidence interval. 

```{r plothawaiiandeetstats}

qqPlot(hawaiiand$CI)

```

I then ran an ANOVA on these data
```{r stats}

tukeyhawaiian <- TukeyHSD(aov(formula = CI ~ genotype, data = hawaiiand))
hawaiian.levels <- tukeyhawaiian$genotype[,4]
multcompLetters(hawaiian.levels)['Letters']
```


```{r plotforhawaiianethanol}

# make summary data for hawaiiane

hawaiiane <- subset(hawaiiane,genotype!='ewIR69')
hesummary <-ddply(hawaiiane,c("genotype"),summarise,N=length(genotype),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N))
hesummary$mep <- hesummary$mean + hesummary$se
hesummary$mem <- hesummary$mean - hesummary$se

ggplot(hawaiiane,aes(x=genotype,y=CI)) +
  ggtitle('hawaiian etoh') +
  geom_boxplot(data=hesummary,aes(x=genotype,y=mean)) + 
  geom_point(data=hesummary,aes(x=genotype,y=mep),shape=3)  +
  geom_point(data=hesummary,aes(x=genotype,y=mem),shape=3)  + 
  geom_jitter(width=0.2,height=0) +
  theme_tufte() +
  ylim(-1,1) + 
  geom_hline(yintercept=0)
```

Below find the stats for these hawaiian ethanol plate data
```{r plothawaiianetohstats}

qqPlot(hawaiiane$CI)

```

```{r statsforhawaiianethanol2}

tukeyhawaiiane <- TukeyHSD(aov(formula=CI~genotype,data=hawaiiane))
Tukeyhe.levels <- tukeyhawaiiane$`genotype`[,4]
multcompLetters(Tukeyhe.levels)['Letters']
```

## Fig 2g-h and 3h
Animals expressing either str-217 rescue construct (str-217p::str-217::SL2::GFP) or ADL rescue construct (srh-220p::str-217::SL2::mCherry) return to being DEET sensitive, indicating _str-217_ is required in each of these strains to confer DEET-sensitivity
```{r plotrescue}

# make summary data for rescue

rescue2 <- subset(allbeh,expt=='rescue2')
rescue <- subset(allbeh,expt=='rescue')
rescueall <- rbind(rescue2,rescue)
rescueD <- subset(rescueall,percentDEET==0.15)

rescueDsummary <-ddply(rescueD,c("genotype"),summarise,N=length(genotype),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N))
rescueDsummary$mep <- rescueDsummary$mean + rescueDsummary$se
rescueDsummary$mem <- rescueDsummary$mean - rescueDsummary$se

ggplot(rescueD,aes(x=genotype,y=CI)) + 
  ggtitle('rescue') + 
  geom_boxplot(data=rescueDsummary,aes(x=genotype,y=mean)) + 
  geom_point(data=rescueDsummary,aes(x=genotype,y=mep),shape=3)  + 
  geom_point(data=rescueDsummary,aes(x=genotype,y=mem),shape=3)  + 
  geom_jitter(width=0.1,height=0) + 
  theme_tufte() + 
  ylim(-1,1) + 
  geom_hline(yintercept=0)
```


```{r statsforrescue}
crisprnoR <- subset(rescueD,genotype=='crispr')
crisprR <- subset(rescueD,genotype=='crispr-r')
ed03noR <- subset(rescueD,genotype=='ed03')
ed03R <- subset(rescueD,genotype=='ed03-r')
ewir74noR <- subset(rescueD,genotype=='ewIR74')
ewir74R <- subset(rescueD,genotype=='ewIR74r')

t.test(crisprnoR$CI,crisprR$CI)
t.test(ed03noR$CI,ed03R$CI)
t.test(ewir74noR$CI,ewir74R$CI)
```


# Fig 3d neurons are not required for complete DEET-sensitivity
```{r ASH}

ASHsum <- ddply(ASH,c("genotype","percentDEET"),summarise,N=length(genotype),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N))
ASHsum$mep <- ASHsum$mean + ASHsum$se
ASHsum$mem <- ASHsum$mean - ASHsum$se



ggplot(ASH,aes(x=percentDEET,y=CI,color=percentDEET)) + 
  ggtitle('testing ASH requirement') +  
  geom_jitter(width=0.01,height=0) + 
  theme_tufte() + 
  ylim(-1,1) + 
  geom_hline(yintercept=0) + 
  geom_point(data=ASHsum,aes(x=percentDEET,y=mep),shape=3) + 
  geom_point(data=ASHsum,aes(x=percentDEET,y=mem),shape=3)  + 
  geom_point(data=ASHsum,aes(x=percentDEET,y=mean),shape=4) + 
  theme_tufte() + 
  geom_hline(yintercept=0) + 
  facet_grid(~genotype)

```

```{r ASHstats}
ASH.aov = aov(CI~as.factor(percentDEET)*genotype,data=ASH)
plot(ASH.aov,which=2)

leveneTest(CI~genotype*as.factor(percentDEET),data=ASH)

tukeyASH <- TukeyHSD(aov(formula=CI~as.factor(percentDEET)*as.factor(genotype),data=ASH))

TukeyASH.levels <- tukeyASH$`as.factor(percentDEET):as.factor(genotype)`[,4]
multcompLetters(TukeyASH.levels)['Letters']

```

## ADL chemical synapses are required for complete DEET-sensitivity

## Figure 3i
```{r plottetx}

# make summary data for tetx

tetx <- subset(allbeh,expt=='tetx')
tetx <- subset(tetx,genotype!='ed03')
#removes one data point where I had an ed03 plate to check stocks after thawing, done at the same time
tetxD <- subset(tetx,percentDEET==0.15)

tetxDsummary <-ddply(tetxD,c("genotype"),summarise,N=length(genotype),mean=mean(CI),sd=sd(CI),se=sd/sqrt(N))
tetxDsummary$mep <- tetxDsummary$mean + tetxDsummary$se
tetxDsummary$mem <- tetxDsummary$mean - tetxDsummary$se

ggplot(tetxD,aes(x=genotype,y=CI)) + 
  ggtitle('tetx')  + 
  geom_point(data=tetxDsummary,aes(x=genotype,y=mep),shape=3)  + 
  geom_point(data=tetxDsummary,aes(x=genotype,y=mem),shape=3)  + 
  geom_point(data=tetxDsummary,aes(x=genotype,y=mean),shape=4)  + 
  geom_jitter(width=0.1,height=0) + 
  theme_tufte() + 
  ylim(-1,1) + 
  geom_hline(yintercept=0)

qqPlot(tetxD$CI)
TukeyHSD(aov(CI~genotype,tetxD))
```






